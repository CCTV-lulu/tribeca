<!doctype html>
<html>
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      #content {
        position: relative;
        display: block;
        width: 800px;
        height: 500px;
        margin: 0 auto;
        overflow: hidden;
      }
      #score {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div id="score">0</div>
    </div>
    <div class="scripts">
      <script src="./third-party/jquery-2.0.0.min.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./third-party/physics.js"></script>
      <script>

        $(function() {

          var score = $('#score');
          var multiplier = 1.0;

          var two = new Two({ width: 800, height: 500 }).appendTo($('#content')[0]);
          var gravity = 0.75;
          var physics = new Physics(gravity);

          two.$domElement = $(two.renderer.domElement);

          var ground = two.makeRectangle(two.width / 2, two.height - 5, two.width, 10);
          ground.depth = 10;
          ground.noStroke();
          ground.fill = 'brown';

          var hero = two.makeRectangle(two.width / 2, two.height / 2, 20, 20);
          hero.height = 20;
          hero.particle = physics.makeParticle(1.0, two.width / 2, two.height / 2);
          hero.particle.position = hero.translation;
          hero.noStroke().fill = 'black';
          hero.destination = new Two.Vector();
          hero.jump = function() {
            this.particle.velocity.y = -25;
            score.html(Math.round(parseInt(score.html()) + 10 * multiplier));
            return this;
          };

          ground.constraint = ground.translation.y - (ground.depth + hero.height) / 2;

          var amount = 100;
          var jumps = _.map(_.range(amount), function(i) {
            var pct = i / amount;
            var theta = pct * Math.PI * 2.0;
            var x = two.width / 2 - Math.random() * two.width * 0.25;
            var y = two.height / 2 - i * 250;
            return addJump(x, y);
          });

          var $window = $(window)
            .bind('mousemove', function(e) {
              var offset = two.$domElement.offset();
              hero.destination.set(e.clientX - offset.left, e.clientY - offset.top);
            })
            .bind('mouseup', function(e) {
              var particle = hero.particle;
              var position = particle.position;
              if (position.y >= ground.constraint) {
                hero.jump();
              }
            });

          physics
            .onUpdate(function() {

              var particle = hero.particle;
              var position = particle.position;

              position.y = Math.min(ground.constraint, position.y);
              position.x += (hero.destination.x - position.x) * 0.125;

              for (var i = 0; i < jumps.length; i++) {
                var jump = jumps[i];
                var within = jump.within(position);
                if (within) {
                  hero.jump();
                  jumps.splice(i, 1);
                  jump.remove();
                  break;
                }
              }

              focusHeight(position.y);
              calculateMultiplier();

              two.update();

            })
            .play();

          function addJump(x, y, r) {

            var radius = r || 50;

            var circle = two.makeCircle(x, y, radius);
            circle.noStroke().fill = 'lightblue';
            circle.within = function(v) {
              var delta = circle.translation.distanceTo(v);
              if (delta < radius) {
                return true;
              }
              return false;
            };

            return circle;

          }

          function focusHeight(posY) {

            var destination = posY - two.height / 2;
            two.scene.translation.y += (- destination - two.scene.translation.y) * 0.125;
            two.scene.translation.y = Math.max(two.scene.translation.y, 0);

          }

          function calculateMultiplier() {
            multiplier += 1 / 60;
            if (hero.translation.y >= ground.constraint) {
              multiplier = 1.0;
            }
          }

        });

      </script>
    </div>
  </body>
</html>